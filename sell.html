<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sell Panel - WinZone</title>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://kit.fontawesome.com/dd6d3987dd.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }

   body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: #f7fafc;
      color: #2d3748;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    nav.top-nav {
     background: linear-gradient(to bottom, #002b5c, #004080);
  color: white;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 40px;
  position: sticky;
  top: 0;
  z-index: 110;
  font-weight: 600;
  font-size: 20px;
  letter-spacing: 0.03em;
  text-transform: uppercase;
  user-select: none;
  box-shadow: none; }

    nav.top-nav h2 {
      margin: 0;
      color: #e2e8f0;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

nav.top-nav button.back-btn i {
  font-size: 100px; /* icon size */
}

    nav.top-nav button.back-btn {
      background-color: transparent;
      color: #e2e8f0;
      padding: 8px 20px;
      border: 8px;
      border-radius: 5px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
      font-size: 15px;
      position: absolute;
      right: 30px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    nav.top-nav button.back-btn:hover {
      background-color: #e2e8f0;
      color: #2c3e50;
      transform: translateY(-50%) scale(1.05);
    }

    nav.top-nav button.back-btn i {
      font-size: 18px;
    }

    h2 {
      text-align: center;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 0px;
      font-size: 28px;
    }

    .tabs {
      display: flex;
  background: white; /* same as nav */
  overflow: hidden;
  margin: 0; /* remove bottom margin so it sticks to nav */
  box-shadow: none; /* remove shadow */
  border-radius: 0; /* no rounded corners to match nav */
}

   .tab {
  position: relative;
  flex: 1;
  text-align: center;
  padding: 18px 0;
  cursor: pointer;
  color: #45617e;
  font-weight: 600;
  font-size: 16px;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  background: transparent;
}

/* Underline hidden by default */
.tab::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 50%;
  width: 0;
  height: 3px;
  background-color: transparent;
  transition: width 0.3s ease, background-color 0.3s ease;
  transform: translateX(-50%);
}

/* Hover underline - only for hovered tab */
.tab:hover::after {
  background-color: #002b5c;
  width: 100%;
}

/* Active tab underline - stays until another is clicked */
.tab.active::after {
  background-color: #4c4baf;
  width: 100%;
}

/* Colors */
.tab:hover {
  background: transparent;
  color: #002b5c;
}

.tab.active {
  background: transparent;
  color: #002b5c;
  font-weight: 700;
}


    .tab-content {
      display: none;
      background: white;
      padding: 30px 40px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.07);
      min-height: 350px;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.4s ease-in-out;
    }
@keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

.form-row {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  margin-bottom: 20px;
}
.form-row input,
.form-row select {
  flex: 1 1 200px;
  padding: 12px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 15px;
  transition: border-color 0.3s;
}
.form-row input:focus,
.form-row select:focus {
  border-color: #00b894;
  outline: none;
}
.btn {
  background: #1e3c72;
  border: none;
  padding: 12px 20px;
  color: white;
  font-weight: bold;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s;
  margin-top: 10px;
}
.btn:hover {
  background: #2d5398;
}

.bill-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
.bill-table th, .bill-table td {
  border: 1px solid #ccc;
  padding: 10px;
}

.invoice-box, .quotes-box {
  max-width: 1200px;
  margin: auto;
  background: white;
  padding: 20px;
  box-shadow: 0 0 10px rgba(0,0,0,0.15);
  border-radius: 10px;
  page-break-inside: avoid;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: #002d72;
  border-bottom: 2px solid #002d72;
  padding-bottom: 10px;
}

.header h1 {
  margin: 0;
}

.company-section {
  display: flex;
  align-items: center;
  padding: 15px 0;
  border-bottom: 1px solid #ccc;
}

.logo img {
  height: 60px;
}

.company-info {
  text-align: center;
  flex: 1;
}

.company-info h2 {
  margin-bottom: 5px;
}

.info-section {
  display: flex;
  justify-content: space-between;
  margin: 20px 0;
}

.bill-to, .meta {
  width: 48%;
  border: 1px solid #ccc;
  padding: 10px;
}

.notes {
  margin: 15px 0;
  padding: 10px;
  font-size: 12px;
  background: #f9f9f9;
  border-left: 4px solid #007bff;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 12px;
}

table th, table td {
  border: 1px solid #999;
  padding: 6px;
  text-align: center;
}

.total {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
}

.bank-details, .tax-summary {
  width: 48%;
  padding: 10px;
  border: 1px solid #ccc;
}

.amount-in-words {
  margin-top: 10px;
  font-style: italic;
  font-weight: bold;
}

.footer-section {
  display: flex;
  justify-content: space-between;
  margin-top: 30px;
  font-size: 12px;
}

.center-sign {
  text-align: center;
}

.bottom-note {
  text-align: center;
  margin-top: 20px;
  font-size: 12px;
  color: #555;
}

.button-group {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin: 40px auto;
}

.print-btn, .pdf-btn {
  padding: 12px 24px;
  font-size: 14px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  color: white;
  transition: background 0.3s ease;
}

.print-btn {
  background: #1e3c72;
}

.print-btn:hover {
  background: #3666be;
}

.pdf-btn {
  background: #1e3c72;
}

.pdf-btn:hover {
  background: #3666be;
}

/* Hide buttons when printing */
@media print {
  .no-print {
    display: none;
  }
  .button-group {
    display: none;
  } 
  .invoice-box, .quotes-box {
    box-shadow: none !important;
    border-radius: 0 !important;
    padding: 0;
  }
}

/* Mobile View */
/* ======== MOBILE RESPONSIVE STYLES ======== */
@media (max-width: 600px) {
  body {
    padding: 10px;
    font-size: 14px;
  }

  nav.top-nav {
    padding: 0 15px;
    height: 50px;
  }

  nav.top-nav button.back-btn {
    padding: 6px 12px;
    font-size: 12px;
  }

  .top-bar h1 {
    font-size: 20px;
  }

  /* Tabs stack vertically */
  .tabs {
    flex-direction: column;
  }

  .tab {
    padding: 12px 10px;
    font-size: 14px;
    text-align: center;
  }

  /* Form rows stack vertically */
  .form-row {
    flex-direction: column;
  }

  .form-row select,
  .form-row input,
  button.btn {
    flex: 1 1 100%;
    margin-bottom: 10px;
    font-size: 14px;
    padding: 10px;
  }

  button.btn {
    width: 100%;
  }

  /* Make tables horizontally scrollable */
  .table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
    margin-bottom: 1rem;
  }

  table.bill-table,
  table.invoice-table,
  table.quotes-table {
    width: 100%;
    min-width: 600px; /* force horizontal scroll on narrow screens */
    border-collapse: collapse;
  }

  table.bill-table th, table.bill-table td,
  table.invoice-table th, table.invoice-table td,
  table.quotes-table th, table.quotes-table td {
    padding: 6px 8px;
    font-size: 13px;
  }

  /* Invoice and quote sections font scaling */
  .invoice-box, .quotes-box {
    padding: 10px;
    font-size: 14px;
  }

  .invoice-box h1,
  .quotes-box h1 {
    font-size: 18px;
  }

  /* Total boxes and buttons */
  .total-box {
    font-size: 16px;
    padding: 10px 0;
  }

  .button-group button.print-btn,
  .button-group button.pdf-btn {
    font-size: 14px;
    padding: 10px;
    width: 48%;
    margin: 5px 1%;
  }

  /* Responsive adjustments for footer and notes */
  .footer-section div, 
  .notes, 
  .bottom-note {
    font-size: 12px;
  }

  /* Bank details and tax summary stacked */
  .total {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
}
/* Hide nav and tabs when printing */
@media print {
  nav, .tabs, .sidebar, .other-non-invoice-elements {
    display: none !important;
  }
  
  body {
    margin: 0;
    padding: 0;
  }

  /* Make the invoice take full width */
  .invoice-container {
    width: 100%;
  }
}


  </style>
</head>
<body>
<nav class="top-nav" role="banner">
    <a href="admin2.html"><button class="back-btn" ><i class="fa-solid fa-home"></button></i></a>
    

 <h2><i class="fas fa-cart-shopping"></i> Sell/Billing</h2>
</nav>
 <div class="container">
 
      <div class="tabs">
        <div class="tab active" onclick="switchTab(0)"><i class="fa-solid fa-bag-shopping"></i> Sell</div>
        <div class="tab" onclick="switchTab(1)"><i class="fa-solid fa-receipt"></i> Invoice</div>
        <div class="tab" onclick="switchTab(2)"><i class="fa-solid fa-file-lines"></i> Quotes</div>
      </div>
    </div>

    <!-- Sell Tab -->
    <div class="tab-content active" id="sellTab">
      <h3>Select Product to Sell</h3>
      <div class="form-row">
        <select id="customerSelect">
          <option value="">Select Customer</option>
        </select>
      </div>
      <div class="form-row">
        <select id="sellCategory" onchange="filterProducts()">
          <option value="">All Categories</option>
          <option value="Electronics">Electronics</option>
          <option value="Stationery">Stationery</option>
          <option value="Household">Household</option>
        </select>
        <select id="productSelect"></select>
        <input type="number" id="sellQty" placeholder="Quantity to Sell" />
      </div>
      <button class="btn" onclick="addToBill()">Add to Bill</button>
<div class="table-wrapper">
      <table class="bill-table" id="billTable">
        <thead>
          <tr>
            <th>S.No</th>
            <th>Description of Goods & Services</th>
            <th>Brand</th>
            
            <th>Qty</th>
            <th>Rate</th>
            
            <th>Taxable Amt</th>
            <th>CGST%</th>
            <th>CGST Amt</th>
            <th>SGST%</th>
            <th>SGST Amt</th>
            <th>Amount</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
</div>
      <div class="total-box" id="totalBox">Total: ₹0.00</div>
      <button class="btn" onclick="generateInvoice()">Save & Generate Invoice</button>
      <button class="btn" onclick="generateQuotes()">Save & Generate Quotes</button>
    </div>

    <!-- Invoice Tab -->
    <div class="tab-content" id="invoiceTab">
      <div class="invoice-box">
        <div class="header">
          <h1>TAX INVOICE</h1>
          <div>Original Recipient</div>
        </div>
        <div class="company-section">
          <img src="https://via.placeholder.com/100x50?text=Logo" class="logo">
          <div class="company-info">
            <h2>Winzone Infotech Pvt. Ltd</h2>
            Tidal Park Madurai
          </div>
        </div>
        <div class="info-section">
          <div class="bill-to"><strong>Bill To:</strong><br>Customer Name</div>
          <div class="meta">
            <strong>Date:</strong><br>
            <strong>Invoice Number:</strong><br>
            <strong>Payment Mode:</strong><br>
            <strong>Document Through:</strong><br>
            <strong>Executive:</strong><br>
            <strong>PC Reference:</strong><br>
            <strong>PC Date:</strong><br>
          </div>
      
      </div>
    <div class="table-wrapper">
      <table class="invoice-table">
          <thead>
            <tr>
              <th>S.No</th>
              <th>Description</th>
              <th>Brand</th>
              <th>Qty</th>
              <th>Rate</th>
              <th>Taxable Amt</th>
              <th>CGST%</th>
              <th>CGST Amt</th>
              <th>SGST%</th>
              <th>SGST Amt</th>
              <th>Total Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr>
            </tr>
            <tr>
              <td colspan="11" class="table-footer">Total No. of Products</td>
            </tr>
          </tbody>
        </table>
        </div>
        <div class="total">
          <div class="bank-details">
            <strong>Bank Details:</strong><br>
            Bank Name: Name Bank<br>
            Acc no: 123-456-7890<br>
            Branch: Main Branch<br>
            IFSC Code: IFSC123
          </div>
          <div class="tax-summary">
            <strong>Total Before Tax:</strong><br>
            <strong>CGST:</strong><br>
            <strong>SGST:</strong><br>
            <strong>Total GST:</strong><br>
            <strong>Round Off:</strong><br>
            <strong>Total After Tax:</strong>
          </div>
        </div>
        <div class="amount-in-words">Amount in words: </div>
        <div class="footer-section">
          <div>
            <strong>Terms & Conditions:</strong><br>
            1. All disputes are subject to Madurai jurisdiction only.<br>
            2. Payment due within 15 days.<br>
            3. Goods once sold will not be taken back.
          </div>
          <div class="center-sign">
            <strong>Recipient Signature</strong><br><br><br>_______________________
          </div>
          <div style="text-align: right;">
            <strong>For Winzone Infotech Pvt Ltd</strong><br><br><br>Authorized Signatory
          </div>
        </div>
        <div class="notes">
          <strong>Notes:</strong> Products are sold under manufacturer warranty only. No return accepted after sale.
        </div>
        <div class="bottom-note">
          This is a computer-generated invoice. Thank you for your business!
        </div>
      </div>

      <div class="button-group">
        <button onclick="window.print()" class="print-btn"><i class="fa-solid fa-print"></i> Print</button>
        <button onclick="downloadPDF()" class="pdf-btn"><i class="fa-solid fa-file-arrow-down"></i> PDF</button>
      </div>
    </div>

    <!-- Quotes Tab -->
    <div class="tab-content" id="quotesTab">
      <div class="quotes-box">
        <div class="header">
          <h1>QUOTATION</h1>
          <div>Customer Copy</div>
        </div>
        <div class="company-section">
          <img src="https://via.placeholder.com/100x50?text=Logo" class="logo">
          <div class="company-info">
            <h2>Winzone Infotech Pvt. Ltd</h2>
            Tidal Park Madurai
          </div>
        </div>
        <div class="info-section">
          <div class="bill-to"><strong>Bill To:</strong><br>Customer Name</div>
          <div class="meta">
            <strong>Date:</strong><br>
            <strong>Quotation Number:</strong><br>
            <strong>Payment Mode:</strong><br>
            <strong>Document Through:</strong><br>
            <strong>Executive:</strong><br>
            <strong>PC Reference:</strong><br>
            <strong>PC Date:</strong><br>
          </div>
        </div>
        <div class="table-wrapper">
        <table class="quotes-table">
          <thead>
            <tr>
              <th>S.No</th>
              <th>Description</th>
              <th>Brand</th>
              <th>Qty</th>
              <th>Rate</th>
              <th>Taxable Amt</th>
              <th>CGST%</th>
              <th>CGST Amt</th>
              <th>SGST%</th>
              <th>SGST Amt</th>
               <th>Total Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr>
            </tr>
            <tr>
              <td colspan="11" class="table-footer">Total No. of Products</td>
            </tr>
          </tbody>
        </table>
        </div>
        <div class="total">
          <div class="bank-details">
            <strong>Bank Details:</strong><br>
            Bank Name: Name Bank<br>
            Acc no: 123-456-7890<br>
            Branch: Main Branch<br>
            IFSC Code: IFSC123
          </div>
          <div class="tax-summary">
            <strong>Total Before Tax:</strong><br>
            <strong>CGST:</strong><br>
            <strong>SGST:</strong><br>
            <strong>Total GST:</strong><br>
            <strong>Round Off:</strong><br>
            <strong>Total After Tax:</strong>
          </div>
        </div>
        <div class="amount-in-words">Amount in words:</div>
        <div class="footer-section">
          <div>
            <strong>Terms & Conditions:</strong><br>
            1. All disputes are subject to Madurai jurisdiction only.<br>
            2. Payment due within 15 days.<br>
            3. Goods once sold will not be taken back.
          </div>
          <div class="center-sign">
            <strong>Recipient Signature</strong><br><br><br>_______________________
          </div>
          <div style="text-align: right;">
            <strong>For Winzone Infotech Pvt Ltd</strong><br><br><br>Authorized Signatory
          </div>
        </div>
        <div class="notes">
          <strong>Notes:</strong> Products are sold under manufacturer warranty only. No return accepted after sale.
        </div>
        <div class="bottom-note">
          This is a computer-generated quotation. Thank you for your business!
        </div>
      </div>
      <div class="button-group">
        <button onclick="window.print()" class="print-btn"><i class="fa-solid fa-print"></i> Print</button>
        <button onclick="downloadQuotesPDF()" class="pdf-btn"><i class="fa-solid fa-file-arrow-down"></i> PDF</button>
      </div>
    </div> 

  </div>

  <script>
/* ==============================
   STATE
================================= */
let billItems = [];
let invoiceCounter = parseInt(localStorage.getItem("invoiceCounter") || "1", 10);
let quotesCounter = parseInt(localStorage.getItem("quotesCounter") || "1", 10);

/* Map for stable tab routing */
const TAB_IDS = ["sellTab", "invoiceTab", "quotesTab"]; // index: 0=sell, 1=invoice, 2=quotes
const HASH_TO_ID = { "#sell": "sellTab", "#invoice": "invoiceTab", "#quotes": "quotesTab" };
const ID_TO_HASH = { "sellTab": "#sell", "invoiceTab": "#invoice", "quotesTab": "#quotes" };

/* ==============================
   INIT (data & dropdowns)
================================= */
window.addEventListener("load", () => {
  const savedBill = localStorage.getItem("savedBill");
  if (savedBill) {
    billItems = JSON.parse(savedBill);
    renderBillTable();
  }
  loadCustomers();
  filterProducts();
});

/* ==============================
   TAB HELPERS (ID-based, hash-aware)
================================= */
function activateTabById(targetId) {
  const tabs = document.querySelectorAll(".tab");             // clickable tab buttons
  const panels = document.querySelectorAll(".tab-content");   // tab panels/sections

  // Deactivate all
  tabs.forEach(t => t.classList.remove("active"));
  panels.forEach(p => {
    p.classList.remove("active");
    p.hidden = true; // make sure it's actually hidden even if CSS is missing
  });

  // Activate panel by ID
  const panel = document.getElementById(targetId);
  if (panel) {
    panel.classList.add("active");
    panel.hidden = false;
  }

  // Try to activate matching tab button:
  // 1) Prefer a button with [data-target="#id"] or [data-target="id"]
  // 2) Fallback: activate the tab button at the same index as TAB_IDS
  let matched = false;
  tabs.forEach((btn, i) => {
    const dt = (btn.getAttribute("data-target") || "").replace(/^#/, "");
    if (dt && dt === targetId) {
      btn.classList.add("active");
      matched = true;
    }
  });
  if (!matched) {
    const i = TAB_IDS.indexOf(targetId);
    if (i >= 0 && tabs[i]) tabs[i].classList.add("active");
  }

  // Sync hash (without adding duplicate history entries)
  const desiredHash = ID_TO_HASH[targetId] || "#sell";
  if (window.location.hash !== desiredHash) {
    history.replaceState(null, "", desiredHash);
  }
}

function handleHash() {
  const id = HASH_TO_ID[window.location.hash] || "sellTab";
  activateTabById(id);
}

/* Backward-compatible: keep index-based API */
function switchTab(index) {
  const id = TAB_IDS[index] || "sellTab";
  activateTabById(id);
  // Also update hash in a consistent way
  const desiredHash = ID_TO_HASH[id] || "#sell";
  if (window.location.hash !== desiredHash) {
    history.replaceState(null, "", desiredHash);
  }
}

/* Wire up once DOM is ready */
document.addEventListener("DOMContentLoaded", () => {
  // Initial route
  handleHash();

  // React to manual hash changes
  window.addEventListener("hashchange", handleHash);

  // Make tab clicks update hash & switch reliably
  // Works with either data-target="#invoiceTab" or index fallback.
  const tabs = document.querySelectorAll(".tab");
  tabs.forEach((tabBtn, i) => {
    tabBtn.addEventListener("click", (e) => {
      // If your tab buttons are <a href="#invoice"> etc., let’s prevent default
      // and route via our handler
      if (tabBtn.tagName.toLowerCase() === "a") e.preventDefault();

      const rawTarget = tabBtn.getAttribute("data-target"); // e.g., "#invoiceTab" or "invoiceTab"
      const targetId = rawTarget ? rawTarget.replace(/^#/, "") : (TAB_IDS[i] || "sellTab");
      const newHash = ID_TO_HASH[targetId] || "#sell";

      // Push hash so back/forward works naturally
      if (window.location.hash !== newHash) {
        window.location.hash = newHash; // this will trigger handleHash()
      } else {
        // If hash is already set (no hashchange fired), just activate directly
        activateTabById(targetId);
      }
    });
  });
});

/* ==============================
   CUSTOMER & PRODUCTS
================================= */
function loadCustomers() {
  const sel = document.getElementById("customerSelect");
  if (!sel) return;
  sel.innerHTML = '<option value="">Select Customer</option>';
  (JSON.parse(localStorage.getItem("customers") || "[]")).forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.email;
    opt.textContent = `${c.businessName} - ${c.city}`;
    sel.appendChild(opt);
  });
}
function filterProducts() {
  const sel = document.getElementById("productSelect");
  if (!sel) return;
  sel.innerHTML = "<option value=''>Select Product</option>";
  
  const categoryEl = document.getElementById("sellCategory");
  const wantCat = categoryEl && categoryEl.value;

  const prods = JSON.parse(localStorage.getItem("products") || "[]");
  prods
    .filter(p => p.stock > 0 && (!wantCat || p.category === wantCat))
    .forEach(p => {
      const o = document.createElement("option");
      // ✅ Value includes both name and brand
      o.value = `${p.name}||${p.brand}`;
      o.textContent = `${p.name} - ${p.brand || "N/A"} (${p.stock} in stock)`;
      sel.appendChild(o);
    });
}


/* ==============================
   BILLING / GST
================================= */
function addToBill() {
  const customer = document.getElementById("customerSelect").value;
  if (!customer) return alert("⚠️ Please select a customer.");

  const selected = document.getElementById("productSelect").value;
  if (!selected) return alert("⚠️ Please select a product.");

  const qty = parseInt(document.getElementById("sellQty").value, 10);
  if (isNaN(qty) || qty <= 0) return alert("⚠️ Enter a valid quantity.");

  // ✅ Extract name + brand from dropdown value
  const [name, brand] = selected.split("||");

  // Get product object
  const prods = JSON.parse(localStorage.getItem("products") || "[]");
  const p = prods.find(x => x.name === name && x.brand === brand);
  if (!p) return alert("❌ Product not found.");

  // ✅ Check stock per product+brand
  if (qty > p.stock) {
    return alert(`❌ Insufficient stock. Only ${p.stock} left for ${p.name} - ${p.brand}.`);
  }

  const rate = parseFloat(p.price) || 0;
  const discount = parseFloat(p.discount) || 0;
  const taxable = (qty * rate) - (discount * qty);

  let cgstRate = parseFloat(p.cgst);
  let sgstRate = parseFloat(p.sgst);
  if ((isNaN(cgstRate) || isNaN(sgstRate)) && p.gst) {
    const totalGst = parseFloat(p.gst) || 0;
    cgstRate = totalGst / 2;
    sgstRate = totalGst / 2;
  } else {
    cgstRate = cgstRate || 0;
    sgstRate = sgstRate || 0;
  }

  const cgstAmt = roundDecimal(taxable * (cgstRate / 100));
  const sgstAmt = roundDecimal(taxable * (sgstRate / 100));
  const total = roundDecimal(taxable + cgstAmt + sgstAmt);

  // Add to bill
  billItems.push({
    name: p.name,
    brand: p.brand,
    qty,
    rate,
    taxable,
    cgstRate,
    cgstAmt,
    sgstRate,
    sgstAmt,
    total
  });

  // ✅ Deduct stock in memory but save after invoice
  // p.stock -= qty; // optional: can deduct immediately if desired

  localStorage.setItem("savedBill", JSON.stringify(billItems));
  renderBillTable();
}

  // ✅ Save back updated products
  localStorage.setItem("products", JSON.stringify(prods));

// Helper function for decimal rounding
function roundDecimal(value) {
  return parseFloat(value.toFixed(2));
}

function renderBillTable() {
  const tbody = document.querySelector("#billTable tbody");
  tbody.innerHTML = "";
  let total = 0;
  let totalTaxable = 0;
  let totalCGST = 0;
  let totalSGST = 0;

  billItems.forEach((item, index) => {
    total += item.total;
    totalTaxable += item.taxable;
    totalCGST += item.cgstAmt;
    totalSGST += item.sgstAmt;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${index + 1}</td>
      <td>${item.name}</td>
      <td>${item.brand}</td>
      <td>${item.qty}</td>
      <td>₹${item.rate.toFixed(2)}</td>
          <td>₹${item.taxable.toFixed(2)}</td>
      <td>${item.cgstRate}%</td>
      <td>₹${item.cgstAmt.toFixed(2)}</td>
      <td>${item.sgstRate}%</td>
      <td>₹${item.sgstAmt.toFixed(2)}</td>
      <td>₹${item.total.toFixed(2)}</td>
      <td><button onclick="removeFromBill(${index})"style="background:#dc3545; color:#fff; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Remove
        </button></td>
    `;
    tbody.appendChild(row);
  });

  document.getElementById("totalBox").textContent = `Total: ₹${total.toFixed(2)}`;
  
  // Update the tax summary in the invoice tab
 
}
function removeFromBill(index) {
  // Remove the item
  billItems.splice(index, 1);

  // Save updated bill in localStorage
  localStorage.setItem("savedBill", JSON.stringify(billItems));

  // Refresh the bill table
  renderBillTable();

  // Show notification
  showNotification("🗑️ Item removed from bill.", "info");
}


/* ==============================
   INVOICE
================================= */
function generateInvoice() {
  if (billItems.length === 0) {
    alert("No items added to the bill.");
    return;
  }

  const customerEmail = document.getElementById("customerSelect")?.value;
  const customers = JSON.parse(localStorage.getItem("customers") || "[]");
  const customer = customers.find(c => c.email === customerEmail);

  const billTo = document.querySelector("#invoiceTab .bill-to");
  if (billTo) {
    billTo.innerHTML = `<strong>Bill To:</strong><br>
      ${customer ? `${customer.name || customer.businessName}<br>
      ${customer.address || ""}<br>
      ${customer.city || ""} - ${customer.pincode || ""}<br>
      GSTIN: ${customer.gstin || "N/A"}` : "N/A"}`;
  }

  const invoiceNumber = `INV-${String(invoiceCounter).padStart(4, "0")}`;
  const today = new Date().toLocaleDateString();

  const headerH1 = document.querySelector("#invoiceTab .header h1");
  if (headerH1) headerH1.textContent = `INVOICE NO: ${invoiceNumber}`;

  const meta = document.querySelector("#invoiceTab .meta");
  if (meta) {
    meta.innerHTML = `
      <strong>Date:</strong> ${today}<br>
      <strong>Invoice Number:</strong> ${invoiceNumber}<br>
      <strong>Payment Mode:</strong> <br>
      <strong>Document Through:</strong> <br>
      <strong>Executive:</strong> <br>
      <strong>PC Reference:</strong> -<br>
      <strong>PC Date:</strong> ${today}
    `;
  }

  const tbody = document.querySelector("#invoiceTab .invoice-table tbody");
  if (tbody) tbody.innerHTML = "";

  let totalTaxable = 0;
  let totalCGST = 0;
  let totalSGST = 0;

  billItems.forEach((item, index) => {
    totalTaxable += item.taxable;
    totalCGST += item.cgstAmt;
    totalSGST += item.sgstAmt;

    if (tbody) {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${index + 1}</td>
        <td>${item.name}</td>
        <td>${item.brand}</td>
        <td>${item.qty}</td>
        <td>₹${item.rate.toFixed(2)}</td>
        <td>₹${item.taxable.toFixed(2)}</td>
        <td>${item.cgstRate}%</td>
        <td>₹${item.cgstAmt.toFixed(2)}</td>
        <td>${item.sgstRate}%</td>
        <td>₹${item.sgstAmt.toFixed(2)}</td>
        <td>₹${item.total.toFixed(2)}</td>
      `;
      tbody.appendChild(row);
    }
  });

  const grandTotal = totalTaxable + totalCGST + totalSGST;
  const amountInWords = numberToWords(Math.round(grandTotal));
  const wordsEl = document.querySelector("#invoiceTab .amount-in-words");
  if (wordsEl) wordsEl.innerText = "Amount in words: " + amountInWords + " only.";

  const taxSummary = document.querySelector("#invoiceTab .tax-summary");
  if (taxSummary) {
    taxSummary.innerHTML = `
      <strong>Total Before Tax:</strong> ₹${totalTaxable.toFixed(2)}<br>
      <strong>CGST:</strong> ₹${totalCGST.toFixed(2)}<br>
      <strong>SGST:</strong> ₹${totalSGST.toFixed(2)}<br>
      <strong>Total GST:</strong> ₹${(totalCGST + totalSGST).toFixed(2)}<br>
      <strong>Round Off:</strong> ₹0.00<br>
      <strong>Total After Tax:</strong> ₹${grandTotal.toFixed(2)}
    `;
  }

  const prods = JSON.parse(localStorage.getItem("products") || "[]");
  billItems.forEach(item => {
    const p = prods.find(x => x.name === item.name);
    if (p) p.stock -= item.qty;
  });
  localStorage.setItem("products", JSON.stringify(prods));

  invoiceCounter++;
  localStorage.setItem("invoiceCounter", String(invoiceCounter));

  billItems = [];
  localStorage.removeItem("savedBill");
  renderBillTable();

  // Route to invoice tab (hashchange will activate)
  window.location.hash = "#invoice";
}

/* ==============================
   QUOTES
================================= */
function generateQuotes() {
  if (billItems.length === 0) {
    alert("No items added to the bill.");
    return;
  }

  const customerEmail = document.getElementById("customerSelect")?.value;
  const customers = JSON.parse(localStorage.getItem("customers") || "[]");
  const customer = customers.find(c => c.email === customerEmail);

  const billTo = document.querySelector("#quotesTab .bill-to");
  if (billTo) {
    billTo.innerHTML = `<strong>Bill To:</strong><br>
      ${customer ? `${customer.name || customer.businessName}<br>
      ${customer.address || ""}<br>
      ${customer.city || ""} - ${customer.pincode || ""}<br>
      GSTIN: ${customer.gstin || "N/A"}` : "N/A"}`;
  }

  const quoteNumber = `QUO-${String(quotesCounter).padStart(4, "0")}`;
  const today = new Date().toLocaleDateString();

  const headerH1 = document.querySelector("#quotesTab .header h1");
  if (headerH1) headerH1.textContent = `QUOTATION NO: ${quoteNumber}`;

  const meta = document.querySelector("#quotesTab .meta");
  if (meta) {
    meta.innerHTML = `
      <strong>Date:</strong> ${today}<br>
      <strong>Quotes Number:</strong> ${quoteNumber}<br>
      <strong>Payment Mode:</strong> <br>
      <strong>Document Through:</strong> <br>
      <strong>Executive:</strong> <br>
      <strong>PC Reference:</strong> -<br>
      <strong>PC Date:</strong> ${today}
    `;
  }

  const tbody = document.querySelector("#quotesTab .quotes-table tbody");
  if (tbody) tbody.innerHTML = "";

  let totalTaxable = 0;
  let totalCGST = 0;
  let totalSGST = 0;

  billItems.forEach((item, index) => {
    totalTaxable += item.taxable;
    totalCGST += item.cgstAmt;
    totalSGST += item.sgstAmt;

    if (tbody) {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${index + 1}</td>
        <td>${item.name}</td>
        <td>${item.brand}</td>
        <td>${item.qty}</td>
        <td>₹${item.rate.toFixed(2)}</td>
        <td>₹${item.taxable.toFixed(2)}</td>
        <td>${item.cgstRate}%</td>
        <td>₹${item.cgstAmt.toFixed(2)}</td>
        <td>${item.sgstRate}%</td>
        <td>₹${item.sgstAmt.toFixed(2)}</td>
        <td>₹${item.total.toFixed(2)}</td>
      `;
      tbody.appendChild(row);
    }
  });

  const grandTotal = totalTaxable + totalCGST + totalSGST;
  const amountInWords = numberToWords(Math.round(grandTotal));
  const wordsEl = document.querySelector("#quotesTab .amount-in-words");
  if (wordsEl) wordsEl.innerText = "Amount in words: " + amountInWords + " only.";

  const taxSummary = document.querySelector("#quotesTab .tax-summary");
  if (taxSummary) {
    taxSummary.innerHTML = `
      <strong>Total Before Tax:</strong> ₹${totalTaxable.toFixed(2)}<br>
      <strong>CGST:</strong> ₹${totalCGST.toFixed(2)}<br>
      <strong>SGST:</strong> ₹${totalSGST.toFixed(2)}<br>
      <strong>Total GST:</strong> ₹${(totalCGST + totalSGST).toFixed(2)}<br>
      <strong>Round Off:</strong> ₹0.00<br>
      <strong>Total After Tax:</strong> ₹${grandTotal.toFixed(2)}
    `;
  }

  localStorage.setItem("savedBill", JSON.stringify(billItems));

  quotesCounter++;
  localStorage.setItem("quotesCounter", String(quotesCounter));

  billItems = [];
  renderBillTable();

  // Route to quotes tab (hashchange will activate)
  window.location.hash = "#quotes";
}

/* ==============================
   UTILITIES
================================= */
function clearSavedBill() {
  localStorage.removeItem("savedBill");
  billItems = [];
  renderBillTable();
  alert("Saved bill cleared.");
}

function downloadPDF() {
  const element = document.querySelector(".invoice-box");
  if (!element) return;

  const opt = {
    margin: 0,
    filename: "invoice.pdf",
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
    jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
    pagebreak: { mode: ["avoid-all", "css", "legacy"] }
  };
  html2pdf().set(opt).from(element).save();
}

function downloadQuotesPDF() {
  const element = document.querySelector(".quotes-box");
  if (!element) return;

  const opt = {
    margin: 0,
    filename: "quotes.pdf",
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
    jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
    pagebreak: { mode: ["avoid-all", "css", "legacy"] }
  };
  html2pdf().set(opt).from(element).save();
}

function numberToWords(num) {
  const a = [
    "", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine",
    "Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen",
    "Seventeen", "Eighteen", "Nineteen"
  ];
  const b = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];

  if (num === 0) return "Zero";
  if (num < 20) return a[num];
  if (num < 100) return b[Math.floor(num / 10)] + (num % 10 !== 0 ? " " + a[num % 10] : "");
  if (num < 1000) return a[Math.floor(num / 100)] + " Hundred" + (num % 100 !== 0 ? " " + numberToWords(num % 100) : "");
  if (num < 1_000_000) return numberToWords(Math.floor(num / 1000)) + " Thousand" + (num % 1000 !== 0 ? " " + numberToWords(num % 1000) : "");
  if (num < 1_000_000_000) return numberToWords(Math.floor(num / 1_000_000)) + " Million" + (num % 1_000_000 !== 0 ? " " + numberToWords(num % 1_000_000) : "");
  return "Number too large";
}

</script>
</body>
</html>
